@{
    ViewData["Title"] = "Home Page";
    var process = ViewBag.Processes;
    //Layout = "_MenuLayout.cshtml";

}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
<link href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css' rel='stylesheet'>

<style>
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    input[type=number] {
        -moz-appearance: textfield;
    }

    .modal-backdrop {
        opacity: 0.01 !important;
    }

    ul {
        list-style-type: none; /* Remove bullets */
        padding: 0; /* Remove padding */
        margin: 0; /* Remove margins */
    }

    li {
        transform: scale(1);
        margin: 10px;
    }

    #dialog.modal-dialog {
        position: fixed;
        bottom: 0;
        right: 0;
        margin: 0;
    }

    #alertModal.fade .modal-dialog {
        transform: translate3d(0, 100vh, 0);
    }

    #alertModal.show .modal-dialog {
        transform: translate3d(0, 0, 0);
    }

    th {
        text-align: center !important;
        font-weight: bold !important;
    }
</style>

<body style="margin-top: 130px">
    <a style="margin-bottom: 10px; color: white" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newOrder">Zamówienie</a>

    <form class="col text-center">
        <div class="list-group-horizontal-sm d-inline-flex align-items-center w-auto">
            <div class="list-group-item">
                <div class="d-inline-flex col text-center">
                    <label for="zleceniaList" style="font-size:20px">[Orders]</label>
                    <select id="zleceniaList" class="form-select" asp-items="@ViewBag.Zlecenia" style="margin-left: 20px; width: 200px; border-color: black; text-align-last: center">
                        <option value="-1" id="defaultOptionForOrder">Select order</option>
                    </select>
                </div>
            </div>
            <div class="list-group-item" style="margin-left:80px">
                <div class="d-inline-flex col text-center">
                    <label for="processList" style="font-size:20px">[Process]</label>
                    <select id="processList" style="margin-left: 20px; width: 200px; border-color: black; text-align-last: center" class="form-select" asp-items="@ViewBag.Processes">
                        <option value="-1" id="defaultOptionForProcess">Select process</option>
                    </select>
                </div>
            </div>
            <div class="list-group-item" style="margin-left:80px" id="machineBlock" hidden>
                <div class="d-inline-flex col text-center">
                    <label for="machinesList" style="font-size:20px">[Machine]</label>
                    <select id="machinesList" class="form-select" style="margin-left: 20px; width: 200px; border-color: black; text-align-last: center">
                    </select>
                </div>
            </div>
            <div class="list-group-item" style="margin-left:80px" id="blockZamówienia" hidden>
                <div class="d-inline-flex col text-center">
                    <a style="margin-bottom: 10px; color: white" class="btn btn-primary" id="btn">Pokaż</a>
                </div>
            </div>

        </div>
    </form>
    <div class="container" style="margin-top:50px" id="container">
        <table id="orders" class="table table-striped table-bordered display col text-center" style="width:100%;margin-top:50px;">
            <thead>
                <tr>
                    <th style="text-align: center">
                    </th>
                    <th id="nMaterialu">Nr. materialu</th>
                    <th id="nazwa">Nazwa produktu</th>
                    <th id="count">Ilość (kg/szt.)</th>
                    <th></th>
                </tr>


            </thead>
        </table>
    </div>
    <div class="modal fade" id="newOrder" backdrop="static" keyboard="false" tabindex="-1" aria-labelledby="title" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="title">Nowe zlecenie</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" id="closeNewZlecenie" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form asp-action="NoveZamówienie" method="Post" id="attachDetachForm">
                        <div class="modal-body">
                            <div class="form-group row">
                                <label for="process" class="col-sm-2 col-form-label">Process</label>
                                <div class="col-sm-6">
                                    <input class="form-control" id="process" readonly style="margin-top:5px;" />
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="machine" class="col-sm-2 col-form-label">Machine</label>
                                <div class="col-sm-6">
                                    <input class="form-control" id="machine" readonly style="margin-top:5px;" />
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="nrZlecenia" class="col-sm-2 col-form-label">Numer zlecenia</label>
                                <div class="col-sm-6">
                                    <input class="form-control" id="nrZlecenia" readonly style="margin-top:5px;" />
                                </div>
                            </div>
                            <div id="enterNumberSection" hidden>
                                <div class="form-group row">
                                    <label for="nrMaterialu" class="col-sm-2 col-form-label">Numer materialu</label>
                                    <div class="col-sm-6">
                                        <input class="form-control" id="nrMaterialu" placeholder="Wpisz numer materialu" />
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label for="ilość" class="col-sm-2 col-form-label">Ilość</label>
                                    <div class="col-sm-6">
                                        <input class="form-control" id="ilość" placeholder="Wpisz ilość zamawianego materialu" />
                                    </div>
                                    <div class="col-sm-12">
                                        <span id="warningText" style="color:red; font-size:small; font-style:normal"></span>
                                    </div>
                                </div>
                                <div class="modal-footer" style="width:100%">
                                    <p>*wszyskie nięzbędne surowce już były zamówione. Wpisz numer materialu oraz ilość i zostaw komętarz!</p>
                                    <div class="form-group" style="width:100%">
                                        <div class="col text-center">
                                            <a class="btn btn-primary" id="saveNSection" onclick="AddByNum()">Zamów</a>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="chekBoxSection" hidden>
                                <div class="form-group" style="width:100%; margin-top: 5px">

                                    <button class="btn btn-light dropdown-toggle" type="button" id="dropdownMenuButton">
                                        Wybierz z listy
                                    </button>

                                    <input value="0" hidden id="count" />
                                </div>
                                <div class="form-group" style="width:100%; margin-top: 5px;">
                                    <div class="container">
                                        <div class="row" style="width:100%">
                                            <div class="col-lg-10" style="float:left;width:50%">
                                                <ul id="list" class="list-group-horizontal-sm" hidden style="padding:5px;">
                                                </ul>

                                            </div>
                                            <div class="col-lg-10" style="float: right !important; width: 50%">
                                                <ul id="list2" class="list-group-horizontal-sm" hidden style="padding:5px;">
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer" style="width:100%">
                                    <div class="form-group" style="width:100%">
                                        <div class="col text-center">
                                            <a class="btn btn-primary" id="saveChSection" disabled onclick="Check()">Zamów</a>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </form>
                </div>

            </div>
        </div>
    </div>
</body>
<footer>
    <div class="modal fade" id="alertModal" style="height: min-content; " tabindex="-1" aria-labelledby="title" aria-hidden="true">
        <div class="modal-dialog" id="dialog">
            <div class="modal-content" style="background-color: transparent;border:none">

                <div class="modal-body" style="background-color: transparent">
                    <p id="textAlert"></p>
                </div>
            </div>
        </div>

    </div>
</footer>




@section Scripts{
    <script>
        var regExp = /[0-9][0-9][0-9][0-9][0-9][0-9][0-9]/;
        var button = document.getElementById("addList");
        var number = document.getElementById('numberCount');
        var proces = document.getElementById('process');
        var machine = document.getElementById('machine');
        var nrZlecenia = document.getElementById('nrZlecenia');
        var nrMaterialu = document.getElementById('nrMaterialu');
        var count = document.getElementById('ilość');

    $(document).ready(function () {
        document.getElementById('zleceniaButton').className = "list-group-item list-group-item-action py-2 ripple active";
        $('#newOrder').modal({ backdrop: 'static', keyboard: false });

        $('#processList').on('change', function () {
            $.ajax({
                method: 'Get',
                url: '/MachineProcess/MachineList',
                data: { 'processId': $('#processList').val() },
                success: function (data) {
                    if ($('#processList option:selected').val() != -1) {
                        $('#machineBlock').removeAttr('hidden');
                        $('#blockZamówienia').removeAttr('hidden');
                        var items = '<option value="-1" id="defaultOptionForMachine">Select machine</option>';
                        for (var i = 0; i < data['id'].length; i++) {
                           items += "<option value=" +data['id'][i]+ ">" + data['name'][i] + "</option>";
                        }
                       // $(data).each(function (index, value) {
                         //   items += "<option value=" + data['id'][index] + ">" + data['id'][index] + data['name'][index] + "</option>";
                        //})
                        $('#machinesList').html(items);
                    } else {
                        $('#machineBlock').attr('hidden', 'true');
                        $('#blockZamówienia').attr('hidden', 'true');
                    }
                }
            })
            $('#dropdownMenuButton').on('click', function () {
                var num = $('#count').val();
                if (num == 0) {
                    $('#list').removeAttr('hidden');
                    $('#list2').removeAttr('hidden');
                    $('#count').val(num + 1);
                } else {
                    $('#list').attr('hidden', 'true');
                    $('#list2').attr('hidden', 'true');
                    $('#count').val(num - 1);
                    $('.form-check-input').prop('checked', false);
                }
            })
        })
        $('#orders').DataTable({
            dom: 'Bfrtip',
            columnDefs: [
                { className: 'dt-body-center', targets: [0, 1, 2, 3, 4] },
                {
                    targets: [1, 2, 3, 4],
                    className: 'dt-head-center'
                },
                {
                    targets: 0,
                    width: '5%'
                },
                {
                    targets: [1, 2],
                    width: '26%'
                },
                {
                    targets: [3],
                    width: '13%'
                },
                {
                    targets: [4],
                    width: '30%'
                }
            ],
            columns: [
                {
                    data: "item4", "render": function (data) {
                        if (data == "Dostarczone") {
                            return "<div style='width:100%; position: center'><i class='bi bi-unlock-fill'></i></div >";
                        }
                        else {
                            return "<div style='width:100%; position: center'><i class='bi bi-lock-fill'></i></div >";
                        }
                    }
                },
                { data: "item1" },
                { data: "item2" },
                { data: "item3" },
                {
                    data: "id", "render": function (data) {
                        return "<div style='width:100%; position: center'><div class='btn-group' role='group' id='groupButton'><a class='btn btn-success btn-small' style = 'height: 5%; margin-left: 5px; margin-right: 5px;' data-toggle='modal' onclick='Details(" + data + ")'>Szczegóły</a><a class='btn btn-danger btn-small' style='height: 5 %' onclick=Delete(" + data + ") id='Delete' >Usuń zlecenie</a></div ></div >"
                    },
                    orderable: false,
                    searchable: false,
                    width: "150px"
                }
            ]
        });
        $('select').on('change', function () {
            $('#container').empty();
            var table = "<table id='orders' class='table table-striped table-bordered display col text-center' style='width: 100%; margin-top: 50px;'>"+
                "<thead><tr><th></th><th id='nMaterialu'>Nr. materialu</th>" +
                    "<th id='nazwa'>Nazwa produktu</th><th id='count'>Ilość (kg/szt.)</th>" +
                "<th></th></tr ></thead ></table>";
            $('#container').html(table);
            $('#orders').DataTable({
                dom: 'Bfrtip',
                ajax: {
                    url: '/MachineProcess/GetOrdersBySelect',
                    type: 'GET',
                    data: { "numerZlecenia": $('#zleceniaList option:selected').val(), "processId": $('#processList option:selected').val(), "machineId": $('#machinesList option:selected').val() },
                    dataSrc: ''
                },
                rowId: 'Id',
                columnDefs: [
                    { className: 'dt-body-center', targets: [0, 1, 2, 3, 4] },
                    {
                        targets: [1, 2, 3, 4],
                        className: 'dt-head-center'
                    },
                    {
                        targets: 0,
                        width: '5%'
                    },
                    {
                        targets: [1, 2],
                        width: '26%'
                    },
                    {
                        targets: [3],
                        width: '13%'
                    },
                    {
                        targets: [4],
                        width: '30%'
                    }
                ],
                columns: [
                    {
                        data: "item4", "render": function (data) {
                            if (data == "Dostarczone") {
                                return "<div style='width:100%; position: center'><i class='bi bi-unlock-fill'></i></div >";
                            }
                            else {
                                return "<div style='width:100%; position: center'><i class='bi bi-lock-fill'></i></div >";
                            }
                        }
                    },
                    { data: "item1" },
                    { data: "item2" },
                    { data: "item3" },
                    {
                        data: "id", "render": function (data) {
                            return "<div style='width:100%; position: center'><div class='btn-group' role='group' id='groupButton'><a class='btn btn-success btn-small' style = 'height: 5%; margin-left: 5px; margin-right: 5px;' data-toggle='modal' onclick='Details(" + data + ")'>Szczegóły</a><a class='btn btn-danger btn-small' style='height: 5 %' onclick=Delete(" + data + ") id='Delete' >Usuń zlecenie</a></div ></div >"
                        },
                        orderable: false,
                        searchable: false,
                        width: "150px"
                    }
                  ]
            });
        })
        /*     ----> working fine
        dataTable = $('#orders').DataTable({
            dom: 'Bfrtip',
            ajax: {
                url: '/MachineProcess/GetOrders',
                type: 'GET',
                dataSrc: ''
            },
            rowId: 'Id',
            columnDefs: [
                { className: 'dt-body-center', targets: [0, 1, 2, 3, 4] },
                {
                    targets: [1, 2, 3, 4],
                    className: 'dt-head-center'
                },
                {
                    targets: 0,
                    width: '5%'
                },
                {
                    targets: [1, 2],
                    width: '26%'
                },
                {
                    targets: [3],
                    width: '13%'
                },
                {
                    targets: [4],
                    width: '30%'
                }
            ],
            columns: [
                {
                    data: "item4", "render": function (data) {
                        if (data == "Dostarczone") {
                            return "<div style='width:100%; position: center'><i class='bi bi-unlock-fill'></i></div >";
                        }
                        else {
                            return "<div style='width:100%; position: center'><i class='bi bi-lock-fill'></i></div >";
                        }
                    }
                },
                { data: "item1" },
                { data: "item2" },
                { data: "item3" },
                {
                    data: "id", "render": function (data) {
                        return "<div style='width:100%; position: center'><div class='btn-group' role='group' id='groupButton'><a class='btn btn-success btn-small' style = 'height: 5%; margin-left: 5px; margin-right: 5px;' data-toggle='modal' onclick='Details(" + data + ")'>Szczegóły</a><a class='btn btn-danger btn-small' style='height: 5 %' onclick=Delete(" + data + ") id='Delete' >Usuń zlecenie</a></div ></div >"
                    },
                    orderable: false,
                    searchable: false,
                    width: "150px"
                }
            ]
        });
        */
        $('#blockZamówienia').on('click', function () {
            $.ajax({
                type: 'Get',
                url: '/MachineProcess/GetIngredients',
                success: function (data) {
                    //nrZlecenia.value = parseInt(data['details']['nrZlecenia']);
                    proces.value = $('#processList option:selected').text();
                    machine.value = $('#machinesList option:selected').text();
                    nrZlecenia.value = $('#zleceniaList option:selected').text();
                    if (data['num'] == 0) {
                        $('#enterNumberSection').removeAttr('hidden');
                        document.getElementById('ilość').addEventListener('keyup', function () {
                            var dataPass = [nrMaterialu.value, this.value];
                            $.ajax({
                                type: 'Get',
                                url: '@Url.Action("GetСount", "MachineProcess")/' + dataPass,
                                success: function (data) {
                                    if (JSON.stringify(data) == 2) {
                                        $('#warningText').text("Chesz zamówić o wiele więcej niż jest potrzebno na wykonania tego zlecenia! ");
                                    }
                                    else if (JSON.stringify(data) == 3) {
                                        $('#warningText').text("Sprawdz ilość zamawianego materialu!! ");
                                    }
                                    else if (JSON.stringify(data) == 1) {
                                        $('#warningText').text("Wszystko OK! ");
                                    }
                                }
                            })
                        });
                        document.getElementById('chekBoxSection').hidden = true;
                    }
                    else {
                        $('#chekBoxSection').removeAttr('hidden');
                        document.getElementById('enterNumberSection').hidden = true;
                        $('#saveChSection').removeAttr('disabled');
                        document.getElementById('saveNSection').disabled = true;
                        $.each(data['items'], function (index, value) {
                            if (data['items'] != null) {
                                if (index % 2 == 0) {
                                    $('#list').append("<li class='list-group-item'><input class='form-check-input' value='" + data['items'][index]['item1'] + "' type='checkbox' id='ingredient1" + index + "' />" +
                                        "<label class='form-check-label' for='Check' id='label' style='margin-left:10px;'>" + data['items'][index]['item2'] + "</label></li > ")
                                }
                                else {
                                    $('#list2').append("<li class='list-group-item'><input class='form-check-input' value='" + data['items'][index]['item1'] + "' type='checkbox' id='ingredient2"+index+"' />" +
                                        "<label class='form-check-label' for='Check' id='label' style='margin-left:10px;'>" + data['items'][index]['item2'] + "</label></li > ")
                                }
                            }
                        })
                        $.each(data['opakowania'], function (index, value) {
                            if (data['opakowania'][index] != null) {
                                if (index % 2 == 0) {
                                    $('#list').append("<li class='list-group-item'><input class='form-check-input' value='" + data['opakowania'][index]['materialNumber'] + "' type='checkbox' id='ingredient3" + index + "' />" +
                                        "<label class='form-check-label' for='Check' id='label' style='margin-left:10px;'>" + data['opakowania'][index]['name'] + "</label></li > ")
                                }
                                else {
                                    $('#list2').append("<li class='list-group-item'><input class='form-check-input' value='" + data['opakowania'][index]['materialNumber'] + "' type='checkbox' id='ingredient4"+index+"' />" +
                                        "<label class='form-check-label' for='Check' id='label' style='margin-left:10px;'>" + data['opakowania'][index]['name'] + "</label></li > ")
                                }
                            }
                        })
                    }
                }
            })
        })
    })
        function AddByNum() {
            Add($("#nrMaterialu"), 'SetByNumberInput', parseInt(count.value), $('#zleceniaList option:selected').val(), $('#processList option:selected').val(), $('#machinesList option:selected').val());
        }
        function Check() {
            Add($("input.form-check-input:checked"), 'PostMethod', 0, $('#zleceniaList option:selected').val(), $('#processList option:selected').val(), $('#machinesList option:selected').val());
        }
        function Add(inputValue, actionName, count, zlecenieNr, processId, machineId) {
            var favorite = [];
            $.each($(inputValue), function () {
                favorite.push($(this).val());
                /////-->work fine ---> favorite.push($('#nrMaterialu').val());
            });
            var dataPass = [];
            for (var i = 0; i < favorite.length; i++) {
                dataPass.push({
                    "id": i, "ingredient": favorite[i],
                    "itemId": parseInt(zlecenieNr),
                    "processId": parseInt(processId),
                    "machineId": parseInt(machineId),
                    "count": count
                });
            }
            alert(JSON.stringify(dataPass));
            $.ajax({
                type: 'POST',
                contentType: 'application/json; charset=utf-8',
                url: '/MachineProcess/' + actionName,
                data: JSON.stringify(dataPass),
                success: function (data) {
                    $('#alertModal').modal('show');
                    $('#textAlert').text('Zamówienie przyjęte do realizacji!');
                    $('#textAlert').css({ "text - align": "center", "color": "green", "font-weight": 600 });
                    setTimeout(function () {
                        $('#alertModal').modal('hide');
                    }, 1500);
                },
                error: function (data) {
                    $('#alertModal').modal('show');
                    $('#textAlert').text('Wystąpił problem!');
                    $('#textAlert').css({ "text - align": "center", "color": "red", "font-weight": 600 });
                    setTimeout(function () {
                        $('#alertModal').modal('hide');
                    }, 1500);
                }
            });
        }
    </script>
}
